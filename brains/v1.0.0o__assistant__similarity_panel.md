# v1.0.0o â€” Similarity analysis restoration

## Context
- Legacy `spectra-app` shipped a similarity panel that helped compare overlays but the refactored build
  lacked parity.
- Overlay traces already expose canonical wavelength/value arrays, making it feasible to port the
  numeric engine into the modular layout.

## Changes
- Added `server/analysis/similarity.py` with the cached metric engine (cosine, RMSE, correlation,
  line-match) plus reusable `TraceVectors` helpers.
- Wired a Streamlit similarity section that respects visible traces, supports viewport toggles,
  normalization, metric selection, and reference choice.
- Documented the UI contract addition and added regression tests for normalization, cache symmetry, and
  viewport alignment behaviour.

## Decisions
- Downsample similarity inputs by simple stride limiting (15k points) to avoid expensive unions until a
  dedicated decimation strategy lands.
- Cached metric computations by trace fingerprint/viewport to avoid recomputing when users tweak
  controls without modifying traces.
- Kept line-match heuristics lightweight (peak distance) to match historical behaviour while leaving
  room for future metadata weighting.

## Tests & Evidence
- `PYTHONPATH=. pytest -q`
- `ruff check .`
- `black --check .`
- `mypy .`
- `python tools/verifiers/Verify-Atlas.py`
- `python tools/verifiers/Verify-PatchNotes.py`
- `python tools/verifiers/Verify-Brains.py`
- `python tools/verifiers/Verify-Handoff.py`
- `PYTHONPATH=. python tools/verifiers/Verify-UI-Contract.py`

## Regressions Prevented
- Restores similarity tooling expected by analysts comparing multiple spectra, reducing friction when
  evaluating overlays.
- Guards against asymmetric cache outputs and ensures viewport trimming honours user-selected bounds.

## Follow-ups
- Persist similarity configuration in export manifests to make bundle replays faithful.
- Explore adaptive resampling/downsampling for ultra-dense spectra to keep metric runtime predictable.
- Investigate weighting line-match scores by species metadata for richer comparisons.

## Checklist
- [x] Patch notes added (`PATCH_NOTES/PATCH_NOTES_v1.0.0(o).md`)
- [x] Handoff updated (`handoffs/HANDOFF_v1.0.0(o).md`)
- [x] Version bumped (`pyproject.toml`, `app/config/version.json`)
- [x] Tests added (`tests/test_similarity.py`)
