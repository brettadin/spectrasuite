# v0.1.0d — ASCII ingestion resilience

## Context
- Goal: make ASCII uploads tolerant to messy export headers so wavelength/flux detection and metadata
  extraction succeed without manual editing.
- Starting point: v0.1.0c trimmed invisible characters but still missed camelCase, spaced, or dashed
  headers (e.g. "FluxDensity", "Wave Length") and failed to harvest metadata aliases.

## Changes
- Added canonical header tokenisation that normalises casing, camel humps, punctuation, and diacritics
  before alias matching in `server/ingest/ascii_loader.py`.
- Expanded wavelength/flux alias sets and metadata synonym maps (Target/Object/Instrument/Telescope/
  Observer) while filtering null-like string values.
- Reworked label inference to prioritise target/object aliases and added regression coverage for messy
  header combinations in `tests/test_ascii_loader.py`.

## Decisions
- Normalise metadata keys into canonical slugs rather than expanding ad-hoc alias lists throughout the
  code so provenance remains consistent and easier to audit.
- Treat "Object" fields as a fallback for `TraceMetadata.target`, preserving the original value in
  `extra["object"]` for replay fidelity.
- Skip null-like strings ("nan", "none", "null") when populating metadata to avoid polluting the
  UI and provenance events.

## Tests & Evidence
- `ruff check .`
- `black --check .`
- `mypy .`
- `PYTHONPATH=. pytest -q`
- `python tools/verifiers/Verify-Atlas.py`
- `python tools/verifiers/Verify-Brains.py`
- `python tools/verifiers/Verify-PatchNotes.py`
- `python tools/verifiers/Verify-Handoff.py`
- `PYTHONPATH=. python tools/verifiers/Verify-UI-Contract.py`

## Regressions Prevented
- Ensures future ASCII ingest refactors continue to recognise camelCase or spaced wavelength/flux
  headers and expanded metadata synonyms.
- Prevents reintroducing null/"nan" metadata leakage into provenance which previously confused the
  deduplication ledger and UI badges.

## Follow-ups
- Extend alias coverage to include uncertainty synonyms encountered in observatory exports (e.g.
  "ErrFlux"), and add fixtures once samples arrive.
- Investigate ingest-time unit normalisation for common flux conventions (erg/s/cm²/Å vs Jy).
- Update Star Hub resolver to surface additional metadata fields exposed via the new alias map.

## Checklist
- [x] Atlas updated (`atlas/ingest_ascii.md`)
- [x] Docs updated (patch notes, handoff)
- [x] Tests updated (`tests/test_ascii_loader.py`)
