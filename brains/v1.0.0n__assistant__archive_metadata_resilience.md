# v1.0.0n â€” Archive metadata resilience

## Context
- Archive ingestion recently landed, but some fixtures and edge fetchers emit canonical spectra without
  populated metadata objects.
- `_merge_metadata` assumed a pre-existing `TraceMetadata`, causing crashes when a spectrum lacked that
  attribute during Star Hub downloads.

## Changes
- Added a guard that initialises `TraceMetadata` on-demand before merging archive annotations.
- Relaxed placeholder ID logic to handle spectra without a `source_hash` attribute gracefully.
- Added regression coverage exercising `_merge_metadata` with a metadata-free stub spectrum.

## Decisions
- Preferred generating a fresh `TraceMetadata` rather than raising errors so archive ingestion remains
  resilient to stub spectra.
- Kept existing field precedence rules (only fill blanks) to avoid clobbering authoritative FITS header
  values even when metadata is synthesised.
- Used targeted helper functions to keep `_merge_metadata` maintainable while satisfying lint
  constraints.

## Tests & Evidence
- `PYTHONPATH=. pytest -q`
- `ruff check .`
- `black --check .`
- `mypy .`
- `python tools/verifiers/Verify-Atlas.py`
- `python tools/verifiers/Verify-PatchNotes.py`
- `python tools/verifiers/Verify-Brains.py`
- `python tools/verifiers/Verify-Handoff.py`
- `PYTHONPATH=. python tools/verifiers/Verify-UI-Contract.py`

## Regressions Prevented
- Stops archive ingestion from crashing when metadata is missing, keeping Star Hub usable for stubbed
  or minimal spectra.
- Maintains provenance and dedupe ledger behaviour by ensuring metadata containers always exist before
  merging.

## Follow-ups
- Catalogue citation/DOI fields across archives so ingestion can enrich metadata further.
- Investigate normalising ingestion helpers to always set `source_hash` for consistency.
- Revisit export manifest wiring to include archive download URIs now that ingestion is resilient.

## Checklist
- [x] Patch notes added (`PATCH_NOTES/PATCH_NOTES_v1.0.0(n).md`)
- [x] Handoff updated (`handoffs/HANDOFF_v1.0.0(n).md`)
- [x] Version bumped (`pyproject.toml`, `app/config/version.json`)
- [x] Tests added (`tests/test_fetcher_ingest.py`)
